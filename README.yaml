---
#
# This is the canonical configuration for the `README.md`
# Run `make readme` to rebuild the `README.md`
#

name: github-action-atmos-terraform-apply

tags:
  - github-action
  - atmos
  - terraform

# License of this project
license: "APACHE2"

github_repo: cloudposse/github-action-atmos-terraform-apply

badges:
  - name: "Latest Release"
    image: "https://img.shields.io/github/release/cloudposse/github-action-atmos-terraform-apply.svg"
    url: "https://github.com/cloudposse/github-action-atmos-terraform-apply/releases/latest"
  - name: "Slack Community"
    image: "https://slack.cloudposse.com/badge.svg"
    url: "https://slack.cloudposse.com"

related: []

description: This Github Action is used to run Terraform apply for a single, Atmos-supported component with a saved planfile in S3 and DynamoDB.

introduction: |-
  This Github Action is used to run Terraform apply for a single, Atmos-supported component with a saved planfile in S3 and DynamoDB.

  Before running this action, first create and store a planfile with the companion action, [github-action-atmos-terraform-plan](https://github.com/cloudposse/github-action-atmos-terraform-plan).

references:
  - name: "github-action-atmos-terraform-plan"
    description: "Companion GitHub Action to create and store Terraform plans for a given component"
    url: "https://github.com/cloudposse/github-action-atmos-terraform-plan"
  - name: "github-action-terraform-plan-storage"
    description: "GitHub Action to store Terraform plans"
    url: "https://github.com/cloudposse/github-action-terraform-plan-storage"

usage: |-
  ### Prerequisites

  This GitHub Action requires AWS access for two different purposes. This action will attempt to first pull a Terraform planfile from a S3 Bucket with metadata in a DynamoDB table with one role. 
  Then the action will run `terraform apply` against that component with another role. We recommend configuring 
  [OpenID Connect with AWS](https://docs.github.com/en/actions/deployment/security-hardening-your-deployments/configuring-openid-connect-in-amazon-web-services) 
  to allow GitHub to assume roles in AWS and then deploying both a Terraform Apply role and a Terraform State role. 
  For Cloud Posse documentation on setting up GitHub OIDC, see our [`github-oidc-provider` component](https://docs.cloudposse.com/components/library/aws/github-oidc-provider/).

  In order to retrieve Terraform State, we configure an S3 Bucket to store plan files and a DynamoDB table to track plan metadata. Both will need to be deployed before running
  this action. For more on setting up those components, see the `gitops` component (__documentation pending__). This action will then use the [github-action-terraform-plan-storage](https://github.com/cloudposse/github-action-terraform-plan-storage) action to update these resources.

  ### Workflow example

  ```yaml
    name: "atmos-terraform-apply"

    on:
      workflow_dispatch:
      pull_request:
        types:
          - closed
        branches:
          - main

    # These permissions are required for GitHub to assume roles in AWS
    permissions:
      id-token: write
      contents: read

    jobs:
      plan:
        runs-on: ubuntu-latest
        steps:
          - name: Plan Atmos Component
            uses: cloudposse/github-action-atmos-terraform-apply@v1
            with:
              component: "foobar"
              stack: "plat-ue2-sandbox"
              component-path: "components/terraform/s3-bucket"
              terraform-apply-role: "arn:aws:iam::111111111111:role/acme-core-gbl-identity-gitops"
              terraform-state-bucket: "acme-core-ue2-auto-gitops"
              terraform-state-role: "arn:aws:iam::999999999999:role/acme-core-ue2-auto-gitops-gha"
              terraform-state-table: "acme-core-ue2-auto-gitops"
              aws-region: "us-east-2"

  ```

include:
  - "docs/github-action.md"

# Contributors to this project
contributors:
  - name: "Erik Osterman"
    github: "osterman"
  - name: "Daniel Miller"
    github: "milldr"
